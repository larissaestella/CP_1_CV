import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import norm, poisson, binom, expon

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="An√°lise de Dados", 
    page_icon="üìä",
    layout="wide")
st.title("üìä An√°lise de Risco de Cr√©dito")

# 1. Apresenta√ß√£o dos dados e tipos de vari√°veis
st.header("1. Apresenta√ß√£o dos Dados e Tipos de Vari√°veis")
st.write("""
        O conjunto de dados analisado refere-se a clientes de uma institui√ß√£o financeira,
    contendo informa√ß√µes pessoais, financeiras e comportamentais, como idade, 
    sal√°rio anual, limite de cr√©dito e hist√≥rico de transa√ß√µes. O objetivo √© 
    analisar o risco de inadimpl√™ncia (vari√°vel default), e entender o perfil 
    dos clientes para subsidiar estrat√©gias de cr√©dito.
    """)

# Dataset
url = 'https://raw.githubusercontent.com/andre-marcos-perez/ebac-course-utils/develop/dataset/credito.csv'
df = pd.read_csv(url)

# Exibi√ß√£o amostra dos dados

df['limite_credito'] = df['limite_credito'].apply(lambda x: float(str(x).replace('.', '').replace(',', '.')))
df['valor_transacoes_12m'] = df['valor_transacoes_12m'].apply(lambda x: float(str(x).replace('.', '').replace(',', '.')))
st.subheader("Amostra dos Dados")
st.dataframe(df.head(300))

# ------------------------------------------------------------
# Convers√£o das colunas num√©ricas

colunas_numericas = [
    'idade', 'dependentes', 'salario_anual', 'meses_de_relacionamento',
    'qtd_produtos', 'iteracoes_12m', 'meses_inativo_12m',
    'limite_credito', 'valor_transacoes_12m', 'qtd_transacoes_12m'
]

for coluna in colunas_numericas:
    df[coluna] = pd.to_numeric(df[coluna], errors='coerce')

    
# ------------------------------------------------------------

# Tipos de vari√°veis
st.subheader("Tipos das Vari√°veis")
tipos = pd.DataFrame(df.dtypes, columns=["Tipo de Dado"])
st.write(tipos)

# Perguntas principais
st.subheader("Principais Perguntas para An√°lise")
st.markdown("""
- Qual √© o perfil dos clientes inadimplentes?
- Existe rela√ß√£o entre o limite de cr√©dito e a inadimpl√™ncia?
- Qual √© o comportamento de transa√ß√µes dos clientes (volume e valor)?
- Como o tempo de relacionamento influencia a inadimpl√™ncia?
""")

st.markdown("---")

# 2. An√°lise Estat√≠stica Descritiva
st.header("2. An√°lise Estat√≠stica Descritiva")

st.subheader("Medidas Centrais")

# Sele√ß√£o de colunas num√©ricas
num_cols = df.select_dtypes(include=['int64', 'float64']).columns

# Tabela resumo
desc = df[num_cols].describe().T
desc['moda'] = df[num_cols].mode().iloc[0]
st.dataframe(desc[['mean', '50%', 'std', 'min', 'max', 'moda']].rename(columns={'50%': 'mediana'}))

# # Distribui√ß√£o dos dados
# st.subheader("Distribui√ß√£o dos Dados (Histogramas)")
# for col in num_cols:
#     fig, ax = plt.subplots()
#     sns.histplot(df[col], kde=True, ax=ax)
#     st.pyplot(fig)

# Correla√ß√£o
st.subheader("Correla√ß√£o entre Vari√°veis")
# corr = df[num_cols].corr()
# fig, ax = plt.subplots(figsize=(10, 8))
# sns.heatmap(corr, annot=True, cmap='coolwarm', ax=ax)
# st.pyplot(fig)

df['meses_de_relacionamento'] = pd.to_numeric(df['meses_de_relacionamento'], errors='coerce')
df['limite_credito'] = pd.to_numeric(df['limite_credito'], errors='coerce')
df['valor_transacoes_12m'] = pd.to_numeric(df['valor_transacoes_12m'], errors='coerce')
df['qtd_transacoes_12m'] = pd.to_numeric(df['qtd_transacoes_12m'], errors='coerce')

# Remover linhas com valores ausentes nas vari√°veis selecionadas
df = df.dropna(subset=['idade', 'dependentes', 'meses_de_relacionamento',
    'qtd_produtos', 'iteracoes_12m', 'meses_inativo_12m',
    'limite_credito', 'valor_transacoes_12m', 'qtd_transacoes_12m'])

# Sele√ß√£o das vari√°veis para correla√ß√£o
selected_cols = ['idade', 'dependentes', 'meses_de_relacionamento',
    'qtd_produtos', 'iteracoes_12m', 'meses_inativo_12m',
    'limite_credito', 'valor_transacoes_12m', 'qtd_transacoes_12m']

# Calculando a correla√ß√£o entre as vari√°veis selecionadas
corr = df[selected_cols].corr()

# Criando o gr√°fico de correla√ß√£o
fig, ax = plt.subplots(figsize=(8, 6))
sns.heatmap(corr, annot=True, cmap='coolwarm', ax=ax)

# Exibindo o gr√°fico
st.pyplot(fig)

# ------------------------------------------------------------
st.markdown("---")

st.header("3. Aplica√ß√£o de Distribui√ß√µes Probabil√≠sticas")

# Distribui√ß√£o Binomial - An√°lise de Inadimpl√™ncia
st.subheader("Distribui√ß√£o Binomial - Probabilidade de Inadimpl√™ncia")

# C√°lculo da probabilidade de inadimpl√™ncia
inadimplentes = df['default'].sum()  # soma de 1's = total inadimplentes
total_clientes = df['default'].count()  # total de registros
prob_inadimplencia = inadimplentes / total_clientes  # propor√ß√£o

# Exibindo os dados
st.write(f"**Total de Clientes:** {total_clientes}")
st.write(f"**Inadimplentes:** {inadimplentes}")
st.write(f"**Probabilidade Real de Inadimpl√™ncia:** {prob_inadimplencia:.2%}")

# Simula√ß√£o da distribui√ß√£o binomial com a probabilidade real
n_trials = 100  # Exemplo: 100 clientes
x = np.arange(0, n_trials + 1)  # N√∫mero de inadimplentes de 0 a 100
binomial_dist = binom.pmf(x, n_trials, prob_inadimplencia)  # PMF binomial

# Plotando o gr√°fico
fig, ax = plt.subplots(figsize=(10, 6))
ax.vlines(x, 0, binomial_dist, colors='purple', lw=2)
ax.set_title('Distribui√ß√£o Binomial - N√∫mero de Inadimplentes em 100 Clientes', fontsize=14)
ax.set_xlabel('N√∫mero de Inadimplentes', fontsize=12)
ax.set_ylabel('Probabilidade', fontsize=12)
plt.grid(True)
st.pyplot(fig)

# Justificativa
st.markdown("""
**Justificativa:** A vari√°vel `default` representa inadimpl√™ncia (1 para inadimplente, 0 para adimplente), o que caracteriza uma vari√°vel bin√°ria.  
Por isso, o modelo de **Distribui√ß√£o Binomial** √© adequado para estimar a probabilidade de ocorr√™ncia de inadimplentes em amostras de clientes.
""")

st.subheader("""Interpreta√ß√£o dos Resultados:""")
st.markdown("""
A probabilidade real de inadimpl√™ncia de 16,07% √© relativamente alta. Isso indica que cerca de 1 em cada 6 clientes est√° inadimplente.
\n Essa taxa √© significativa e pode ser uma preocupa√ß√£o para a empresa, j√° que ela representa um risco financeiro consider√°vel.
\n A empresa precisa entender o que est√° causando esse alto n√≠vel de inadimpl√™ncia. Isso pode ser relacionado a quest√µes econ√¥micas, pol√≠ticas de cr√©dito mais flex√≠veis ou at√© mesmo a falta de controle adequado na an√°lise de cr√©dito dos clientes. A empresa pode usar esses dados para identificar grupos de clientes mais propensos a inadimpl√™ncia (por exemplo, com base em hist√≥rico de cr√©dito, comportamento de pagamento, renda, etc.).
A an√°lise tamb√©m pode ajudar a descobrir se h√° uma concentra√ß√£o maior de inadimplentes em determinados segmentos de mercado ou regi√µes geogr√°ficas.

\n A taxa de inadimpl√™ncia de 16,07% √© uma indica√ß√£o clara de que a empresa enfrenta desafios relacionados √† recupera√ß√£o de cr√©dito. A ado√ß√£o de uma abordagem anal√≠tica para segmentar clientes, ajustar pol√≠ticas de concess√£o de cr√©dito e monitorar continuamente o risco de inadimpl√™ncia s√£o medidas cruciais para minimizar o impacto financeiro e garantir a sustentabilidade a longo prazo.""")

st.markdown("---")

# ----------------- An√°lise Poisson - Rela√ß√£o entre Tempo de Relacionamento e Inadimpl√™ncia ----------------------

# Garantindo que as colunas est√£o no formato correto
df['meses_de_relacionamento'] = pd.to_numeric(df['meses_de_relacionamento'], errors='coerce')
df['default'] = pd.to_numeric(df['default'], errors='coerce')
df = df.dropna(subset=['meses_de_relacionamento', 'default'])

st.subheader("Distribui√ß√£o de Poisson - Rela√ß√£o entre Tempo de Relacionamento e Inadimpl√™ncia")

# Filtrando clientes inadimplentes
inadimplentes_df = df[df['default'] == 1]

# Calculando a taxa de inadimpl√™ncia (Œª) - como a distribui√ß√£o de Poisson modela a quantidade de eventos (inadimpl√™ncias)
# Vamos contar as inadimpl√™ncias por intervalo de tempo (meses de relacionamento)
taxa_inadimplencia = len(inadimplentes_df) / df['meses_de_relacionamento'].sum()

# Exibindo a taxa de inadimpl√™ncia
st.write(f"**Total de Clientes:** {len(df)}")
st.write(f"**Inadimplentes:** {len(inadimplentes_df)}")
st.write(f"**Taxa de Inadimpl√™ncia (Œª):** {taxa_inadimplencia:.5f}")

# Criando o gr√°fico da distribui√ß√£o de Poisson
fig, ax = plt.subplots(figsize=(10, 6))

# Gerando os dados para a distribui√ß√£o de Poisson
max_mes = int(df['meses_de_relacionamento'].max())  # Maximo de meses
x = np.arange(0, max_mes + 1)
y = poisson.pmf(x, taxa_inadimplencia)  # Fun√ß√£o de massa de probabilidade (PMF) de Poisson

# Plotando a distribui√ß√£o
ax.plot(x, y, 'bo', ms=8, label='Distribui√ß√£o Poisson', color='purple')
ax.vlines(x, 0, y, colors='purple', lw=5)

ax.set_title('Distribui√ß√£o de Poisson - Tempo de Relacionamento e Inadimpl√™ncia', fontsize=14)
ax.set_xlabel('Meses de Relacionamento', fontsize=12)
ax.set_ylabel('Probabilidade de Inadimpl√™ncia', fontsize=12)
ax.legend()

# Exibindo o gr√°fico
st.pyplot(fig)

# Justificativa
st.markdown("""
**Justificativa:** A **distribui√ß√£o de Poisson** √© utilizada para modelar a ocorr√™ncia de eventos (como a inadimpl√™ncia) em intervalos de tempo fixos. 
Neste caso, estamos considerando a inadimpl√™ncia como um evento que pode ocorrer ao longo do tempo de relacionamento com o cliente. 
A taxa de inadimpl√™ncia (Œª) √© calculada com base na quantidade de inadimplentes e o tempo de relacionamento. O gr√°fico gerado mostra a probabilidade 
de inadimpl√™ncia ao longo do tempo de relacionamento, de acordo com a distribui√ß√£o de Poisson.
""")

st.subheader("""Interpreta√ß√£o dos Resultados:""")
st.markdown("""
 A **Taxa de Inadimpl√™ncia:** de 0.00447 significa que, em m√©dia, cerca de 0.45% dos clientes est√£o inadimplentes. Esse valor √© relativamente baixo, indicando que a maioria dos clientes est√° cumprindo com suas obriga√ß√µes de pagamento.
\n Essa taxa pode ser √∫til para entender o risco financeiro que a empresa enfrenta. Uma taxa de inadimpl√™ncia baixa pode sugerir que a empresa possui um bom controle de cr√©dito ou que a maior parte de seus clientes est√° em boa situa√ß√£o financeira. 
√© utilizada para modelar a ocorr√™ncia de eventos (como a inadimpl√™ncia) em intervalos de tempo fixos. 
Neste caso, estamos considerando a inadimpl√™ncia como um evento que pode ocorrer ao longo do tempo de relacionamento com o cliente. 
A taxa de inadimpl√™ncia (Œª) √© calculada com base na quantidade de inadimplentes e o tempo de relacionamento. O gr√°fico gerado mostra a probabilidade 
de inadimpl√™ncia ao longo do tempo de relacionamento, de acordo com a distribui√ß√£o de Poisson.
\n A distribui√ß√£o dos limites de cr√©dito entre os clientes inadimplentes e n√£o inadimplentes pode revelar padr√µes no comportamento dos clientes. Por exemplo, clientes inadimplentes podem ter limites de cr√©dito mais altos ou mais baixos em compara√ß√£o com os clientes n√£o inadimplentes.
\n Em resumo, a an√°lise da taxa de inadimpl√™ncia e da distribui√ß√£o de limites de cr√©dito entre os clientes inadimplentes e n√£o inadimplentes oferece insights importantes sobre o risco financeiro da empresa. Isso permite ajustes na pol√≠tica de cr√©dito e na segmenta√ß√£o dos clientes para minimizar o impacto da inadimpl√™ncia.
""")

st.markdown("---")

df['limite_credito'] = pd.to_numeric(df['limite_credito'], errors='coerce')
df['default'] = pd.to_numeric(df['default'], errors='coerce')
df = df.dropna(subset=['limite_credito', 'default'])

# ----------------- An√°lise Binomial - Rela√ß√£o Limite de Cr√©dito e Inadimpl√™ncia ----------------------

st.subheader("Distribui√ß√£o Binomial - Rela√ß√£o entre Limite de Cr√©dito e Inadimpl√™ncia")

# Definindo faixas para o limite de cr√©dito
limite_credito_bins = pd.cut(df['limite_credito'], bins=10)  # Dividindo em 10 faixas
df['faixa_limite_credito'] = limite_credito_bins

# Calculando a probabilidade de inadimpl√™ncia em cada faixa de limite de cr√©dito
probabilidades_inadimplencia = df.groupby('faixa_limite_credito')['default'].mean()

# Exibindo a probabilidade de inadimpl√™ncia por faixa de limite de cr√©dito
# st.write("Probabilidade de Inadimpl√™ncia por Faixa de Limite de Cr√©dito:")
# st.write(probabilidades_inadimplencia)

# Calculando a distribui√ß√£o Binomial para cada faixa de limite de cr√©dito
fig, ax = plt.subplots(figsize=(10, 6))

# Iterando pelas faixas de limite de cr√©dito para plotar a distribui√ß√£o binomial para cada faixa
for faixa, prob in probabilidades_inadimplencia.items():
    n_trials = 100  # N√∫mero de tentativas (clientes)
    x = np.arange(0, n_trials + 1)
    binomial_dist = binom.pmf(x, n_trials, prob)
    
    ax.vlines(x, 0, binomial_dist, lw=2, label=f'Faixa: {faixa} (Prob: {prob:.2f})')

# Ajustando o gr√°fico
ax.set_title('Distribui√ß√£o Binomial - Limite de Cr√©dito e Inadimpl√™ncia', fontsize=14)
ax.set_xlabel('N√∫mero de Inadimplentes em 100 Clientes', fontsize=12)
ax.set_ylabel('Probabilidade', fontsize=12)
ax.legend(title="Faixas de Limite de Cr√©dito")

# Exibindo o gr√°fico
st.pyplot(fig)

# Justificativa
st.markdown("""
**Justificativa:** A **Distribui√ß√£o Binomial** √© utilizada para modelar a probabilidade de inadimpl√™ncia com base em diferentes faixas de limite de cr√©dito.
 Para cada faixa de limite, foi calculado a probabilidade m√©dia de inadimpl√™ncia e aplicado essa probabilidade para modelar o n√∫mero esperado de inadimplentes
 em uma amostra de 100 clientes.
""")

st.subheader("""Interpreta√ß√£o dos Resultados:""")
st.markdown("""
    A an√°lise da probabilidade de inadimpl√™ncia para diferentes faixas de limite de cr√©dito sugere que, em algumas faixas de limite, a probabilidade
     de inadimpl√™ncia pode ser mais elevada. Isso pode indicar que clientes com limite de cr√©dito mais alto possuem maior risco de inadimpl√™ncia, 
     possivelmente devido a comportamentos de maior risco associados ao cr√©dito dispon√≠vel.
\n A rela√ß√£o entre limite de cr√©dito e inadimpl√™ncia pode refletir comportamentos financeiros de clientes. Clientes com 
limites mais altos podem n√£o ter a disciplina financeira necess√°ria para lidar com esses limites, ou podem ter maiores dificuldades econ√¥micas que impactam 
sua capacidade de pagar. Com base nessa an√°lise, a empresa pode considerar ajustar suas pol√≠ticas de concess√£o de cr√©dito, oferecendo limites 
mais conservadores ou fazendo uma an√°lise mais detalhada do perfil de risco dos clientes antes de aprovar limites elevados. A empresa pode segmentar seus clientes com base no limite de cr√©dito e nas taxas de inadimpl√™ncia para adotar estrat√©gias mais 
personalizadas, como ofertas de cr√©dito de menor risco para grupos mais vulner√°veis.
\n A an√°lise tamb√©m pode ser usada para monitorar o risco de inadimpl√™ncia em tempo real, permitindo que a empresa
 identifique e reaja rapidamente a padr√µes de inadimpl√™ncia emergentes em diferentes faixas de limite de cr√©dito.
\n A an√°lise binomial da rela√ß√£o entre limite de cr√©dito e inadimpl√™ncia fornece insights valiosos sobre o risco associado ao cr√©dito oferecido pela 
empresa. O modelo pode ser √∫til para ajustar as estrat√©gias de concess√£o de cr√©dito e minimizar o impacto financeiro da inadimpl√™ncia, promovendo uma 
abordagem mais equilibrada entre riscos e benef√≠cios para a empresa""")

# Conclus√£o
st.markdown("---")
st.header("4. Conclus√µes da An√°lise")
st.markdown("""
- A maioria dos clientes possui limite de cr√©dito entre valores bem concentrados.
- A inadimpl√™ncia est√° presente em uma porcentagem significativa dos clientes, o que justifica o uso da binomial.
- O tempo de relacionamento tamb√©m influencia a inadimpl√™ncia, com clientes com mais tempo de relacionamento apresentando menores taxas de inadimpl√™ncia, o que pode indicar maior fidelidade.
- Poss√≠veis clientes de risco podem ser identificados por padr√µes em vari√°veis como limite de cr√©dito e tempo de relacionamento.
""")

# Rodap√©
st.markdown("---")
st.markdown("Desenvolvido por Larissa Estella.")
